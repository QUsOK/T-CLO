name: Deploy Infra & Config

on:
  workflow_dispatch: # déclenchement manuel

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Récupération du code
      - name: Checkout repository
        uses: actions/checkout@v5

      # 2️⃣ Connexion à Azure via OIDC
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # 3️⃣ Installation Terraform
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.12.1

      # 4️⃣ Installation Ansible
      - name: Install Ansible
        run: |
          sudo apt update
          sudo apt install -y ansible jq

      # 5️⃣ Terraform init & apply
      - name: Terraform Apply
        working-directory: ./terraform/iaas
        env:
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        run: |
          terraform init -input=false
          terraform apply -auto-approve

      # 6️⃣ Export SSH Private Key from Terraform output
      - name: Export SSH private key
        working-directory: ./terraform/iaas
        run: |
          terraform output -raw ssh_private_key > tls_private_key.pem
          chmod 600 tls_private_key.pem

      # 7️⃣ Générer l’inventaire Ansible
      - name: Generate Ansible inventory
        working-directory: ./terraform/iaas
        run: |
          mkdir -p ../../ansible_quickstart
          VM_IP=$(terraform output -raw vm_public_ip)
          echo "$VM_IP ansible_user=azureuser ansible_ssh_private_key_file=./tls_private_key.pem" > ../../ansible_quickstart/inventory.ini

      # 8️⃣ Wait for SSH to be ready
      - name: Wait for SSH
        working-directory: ./ansible_quickstart
        run: |
          VM_IP=$(cat inventory.ini | awk '{print $1}')
          ansible all -i inventory.ini -m wait_for -a "host=$VM_IP port=22 timeout=300" \
            -e "ansible_ssh_common_args='-o StrictHostKeyChecking=no'"

      # 9️⃣ Run Ansible Playbook
      - name: Run Ansible Playbook
        working-directory: ./ansible_quickstart
        run: |
          ansible-playbook -i inventory.ini playbook.yml \
            -e "ansible_ssh_common_args='-o StrictHostKeyChecking=no'"


